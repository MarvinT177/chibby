
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Proof of Concept, Proven Value</title>
<script src="d3.v7.min.js"></script>
<style>
:root{
  --card-bg:#fff;
  --shadow-lg:0 4px 10px rgba(0,0,0,.12);
  --shadow-sm:0 2px 4px rgba(0,0,0,.08);
  --thin-green:#22ff55;                    /* halo + thin-file colour */
}
body{
  font-family:"Helvetica Neue",Arial,sans-serif;
  background:#f5f5f5;
  margin:0;
  padding:14px;
  color:#333;
  font-size:13px;
}
h1{
  text-align:center;
  margin:0 0 10px;
  font-size:1.15rem;
}

/* ---------- FLEX LAYOUT ---------- */
#dashboard{
  display:flex;
  gap:14px;
  align-items:flex-start;
  justify-content:center;
  flex-wrap:wrap;
}
#left-col, #right-col{
  display:flex;
  flex-direction:column;
  gap:12px;
}
#center-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}
@media(max-width:900px){
  #dashboard{flex-direction:column;align-items:center}
}

/* ---------- METRIC CARDS ---------- */
.metric-box{
  background:var(--card-bg);
  border-radius:8px;
  padding:6px 10px;
  box-shadow:var(--shadow-lg);
  text-align:center;
  min-width:140px;
}
.metric-box h3{
  margin:0 0 3px;
  font-size:.72rem;
  color:#666;
}
.metric-box span{font-size:1.05rem;font-weight:600}
.sub-metrics{display:flex;gap:6px;margin-top:3px;justify-content:center;flex-wrap:wrap}
.sub-box{
  background:#f6f7f9;
  border-radius:6px;
  padding:4px 4px;
  min-width:64px;
  box-shadow:var(--shadow-sm);
}
.sub-box h4{margin:0;font-size:.55rem;font-weight:600;color:#555;text-align:center}
.sub-box span{font-size:.7rem;font-weight:600}
.thin-num{font-size:1rem;font-weight:600;color:var(--thin-green)}
input[type=number]{
  width:56px;
  border:1px solid #aaa;
  border-radius:6px;
  padding:3px 5px;
  text-align:right;
  font-size:.7rem;
}

/* ---------- THIN-FILE TOGGLE ---------- */
#thin-toggle{
  margin-top:4px;
  border:none;
  border-radius:6px;
  font-size:.62rem;
  padding:3px 8px;
  cursor:pointer;
  box-shadow:var(--shadow-sm);
  background:#616161;
  color:#fff;
}
#thin-toggle.active{
  background:var(--thin-green);
  color:#000;
}

/* ---------- SLIDER CONTROLS ---------- */
#controls{
  display:flex;
  gap:10px;
  align-items:center;
  background:var(--card-bg);
  border-radius:8px;
  box-shadow:var(--shadow-sm);
  padding:5px 12px;
  border:1px solid #d5d5d5;
  font-size:.7rem;
}
input[type=range]{
  -webkit-appearance:none;
  width:150px;
  height:4px;
  background:#d0d0d0;
  border-radius:3px;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:12px;height:12px;border-radius:50%;
  background:#616161;border:2px solid #fff;cursor:pointer;box-shadow:var(--shadow-sm)
}
input[type=range]::-moz-range-thumb{
  width:12px;height:12px;border-radius:50%;
  background:#616161;border:2px solid #fff;cursor:pointer;box-shadow:var(--shadow-sm)
}
button{
  background:#616161;color:#fff;border:none;border-radius:6px;
  padding:3px 10px;font-size:.7rem;cursor:pointer;box-shadow:var(--shadow-sm)
}
button:hover{background:#424242}

/* ---------- CHART & ROI ---------- */
svg#scatter{
  background:linear-gradient(160deg,#e9f4ff 0%,#ffffff 70%);
  border-radius:10px;
  box-shadow:var(--shadow-lg);
}
#roi-box{
  background:var(--card-bg);
  border-radius:8px;
  padding:6px 10px;
  box-shadow:var(--shadow-lg);
  text-align:center;
  min-width:140px;
}
#roi-box h3{margin:0 0 3px;font-size:.72rem;color:#666}
#roi-chart svg{overflow:visible}

/* ---------- PULSING HALO ---------- */
@keyframes pulse{
  0%   {r:14;opacity:.8}
  50%  {r:26;opacity:0}
  100% {r:14;opacity:.8}
}
</style>
</head>
<body>
<h1>Proof of Concept, Proven Value</h1>

<div id="dashboard">
  <!-- LEFT COLUMN -->
  <div id="left-col">
    <div class="metric-box">
      <h3>Combined Approval</h3><span id="acc-rate">0%</span>
      <div class="sub-metrics">
        <div class="sub-box"><h4>Bank</h4><span id="acc-bank">0%</span></div>
        <div class="sub-box"><h4>Telco</h4><span id="acc-telco">0%</span></div>
      </div>
    </div>
    <div class="metric-box">
      <h3>Combined Default</h3><span id="def-rate">0%</span>
      <div class="sub-metrics">
        <div class="sub-box"><h4>Bank</h4><span id="def-bank">0%</span></div>
        <div class="sub-box"><h4>Telco</h4><span id="def-telco">0%</span></div>
      </div>
      <div style="margin-top:3px;font-size:.62rem;color:#555">
        Target % <input id="target-def" type="number" min="0" max="100" step="0.1">
      </div>
    </div>
  </div>

  <!-- CENTER COLUMN -->
  <div id="center-col">
    <svg id="scatter" width="540" height="420"></svg>
    <div id="controls">
      <label for="threshold"><strong>Score ≥</strong> <span id="thresh-val">1</span></label>
      <input type="range" id="threshold" min="1" max="10" step="1" value="1">
      <button id="toggle">Play</button>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div id="right-col">
    <div class="metric-box">
      <h3>Peso Benefit</h3>
      <div class="sub-metrics" style="gap:5px">
        <div class="sub-box"><h4>Net/Loan</h4><span id="benefit-loan">₱0</span></div>
        <div class="sub-box"><h4>Avg/App</h4><span id="benefit-app">₱0</span></div>
        <div class="sub-box"><h4>Bank Avg</h4><span id="benefit-app-bank">₱0</span></div>
      </div>
    </div>

    <div class="metric-box">
      <h3>Thin-File Gains</h3>
      <span id="thin-count" class="thin-num">0</span>
      <button id="thin-toggle">Highlight</button>
    </div>

    <div id="roi-box">
      <h3>ROI Curve</h3>
      <div id="roi-chart"></div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const REV  = 2500;           // revenue per loan
const LGD  = 6500;           // loss given default
const CSV  = "data.csv";     // embedded or remote CSV path
const RAD  = 10;             // point radius
const FADE = 0.25;           // opacity for grey-out
const BASE = 0.70;           // 70 % bank-only baseline

/* ---------- SCALES & SVG ---------- */
const svg=d3.select("#scatter"),
      W=+svg.attr("width"), H=+svg.attr("height"),
      M={top:38,right:40,bottom:60,left:80};

const x=d3.scaleLinear().domain([1,10]).range([M.left+RAD, W-M.right-RAD]),
      y=d3.scaleLinear().domain([1,10]).range([M.top+RAD,  H-M.bottom-RAD]),
      colour=d3.scaleThreshold()
               .domain([.11,.20,.32,.42,.50])
               .range(["#9CCC65","#D4E157","#FFEE58","#FFCA28","#FFA726","#FF7043"]);

/* ---------- DATA LOAD ---------- */
d3.csv(CSV, d3.autoType).then(raw => {

  /* Clean + aggregate rows into unique (Telco, Bank, Comb) buckets */
  const data = d3.rollups(
      raw.filter(r=>!Object.values(r).some(v=>v==="#N/A"||v===null)),
      v => ({
          telco: v[0]["FinScore Telco"],
          bank : v[0]["Bank Internal Score"],
          comb : v[0]["Combined Score"],
          bad  : d3.mean(v,d=>d["Good/Bad Flag"]),
          n    : v.length
      }),
      d => `${d["FinScore Telco"]}-${d["Bank Internal Score"]}-${d["Combined Score"]}`
  ).map(d=>d[1]);

  /* Scale denominator so bank-only approval ~70 % at threshold 1 */
  const booked   = d3.sum(data,d=>d.n);
  const totalApps= booked / BASE;

  /* ---------- AXES + LABELS ---------- */
  svg.append("g")
      .attr("transform",`translate(0,${H-M.bottom})`)
      .call(d3.axisBottom(x).ticks(10))
      .selectAll(".domain,.tick line").attr("stroke","#7f7f7f").attr("stroke-width",1.4);

  svg.append("g")
      .attr("transform",`translate(${M.left},0)`)
      .call(d3.axisLeft(y).ticks(10))
      .selectAll(".domain,.tick line").attr("stroke","#7f7f7f").attr("stroke-width",1.4);

  svg.append("text")
      .attr("x",W/2).attr("y",H-M.bottom+42)
      .attr("text-anchor","middle")
      .attr("font-size",".8rem").attr("font-weight","bold")
      .text("FinScore Telco Score");

  svg.append("text")
      .attr("x",-H/2).attr("y",M.left-60)
      .attr("transform","rotate(-90)")
      .attr("text-anchor","middle")
      .attr("font-size",".8rem").attr("font-weight","bold")
      .text("Bank Internal Score");

  /* ---------- DOTS ---------- */
  const defs = svg.append("defs");
  defs.append("filter").attr("id","drop")
      .append("feDropShadow")
      .attr("dx",1).attr("dy",1).attr("stdDeviation",1)
      .attr("flood-color","#000").attr("flood-opacity",.32);

  defs.append("filter").attr("id","inner")
      .html('<feGaussianBlur stdDeviation="1.5" result="b"/><feComposite operator="over" in2="b"/>');

  const gDots = svg.append("g").attr("filter","url(#drop)");

  gDots.selectAll("circle.main")
      .data(data).join("circle")
      .attr("class","main")
      .attr("cx",d=>x(d.telco))
      .attr("cy",d=>y(d.bank))
      .attr("r",RAD)
      .attr("fill",d=>colour(d.bad))
      .attr("filter","url(#inner)")
      .attr("stroke","#333").attr("stroke-width",.4);

  gDots.selectAll("circle.hl")
      .data(data).join("circle")
      .attr("class","hl")
      .attr("cx",d=>x(d.telco)-RAD/3)
      .attr("cy",d=>y(d.bank)-RAD/3)
      .attr("r",RAD*.4)
      .attr("fill","#fff")
      .attr("opacity",.18)
      .attr("pointer-events","none");

  gDots.selectAll("text")
      .data(data).join("text")
      .attr("x",d=>x(d.telco))
      .attr("y",d=>y(d.bank))
      .attr("dy",".35em")
      .attr("text-anchor","middle")
      .attr("font-size",".58rem")
      .attr("font-weight","600")
      .attr("fill","#000")
      .text(d=>d3.format(".0%")(d.bad));

  /* ---------- TOOLTIP ---------- */
  const tip=d3.select("body").append("div")
      .style("position","absolute").style("pointer-events","none")
      .style("background","#fff").style("border","1px solid #ccc")
      .style("padding","4px 7px").style("border-radius","6px")
      .style("box-shadow","var(--shadow-sm)").style("font-size",".65rem")
      .style("opacity",0);

  gDots.selectAll("circle.main")
      .on("mouseover",(e,d)=>tip.style("opacity",1).html(
        `<strong>T:</strong> ${d.telco}&nbsp;<strong>B:</strong> ${d.bank}<br>
         Comb: ${d.comb}  Pd: ${(d.bad*100).toFixed(1)}%<br>N: ${d.n}`))
      .on("mousemove",(e)=>tip.style("left",(e.pageX+9)+"px").style("top",(e.pageY-26)+"px"))
      .on("mouseout",()=>tip.style("opacity",0));

  /* ---------- METRIC HELPERS ---------- */
  const stats = f=>{
      const s = data.filter(f),
            n = d3.sum(s,d=>d.n);
      return {acc:n/totalApps, pd:n?d3.sum(s,d=>d.n*d.bad)/n:0};
  };

  /* ---------- ROI CURVE ---------- */
  const roi=d3.range(1,11).map(t=>{
        const s=stats(d=>d.comb>=t);
        return {t,net:(REV-(s.pd*LGD))*s.acc};
      }),
      peak=roi.reduce((a,b)=>b.net>a.net?b:a),
      rW=140,rH=140,rM=24,
      rx=d3.scaleLinear().domain([1,10]).range([0,rW-rM]),
      ry=d3.scaleLinear().domain([0,d3.max(roi,d=>d.net)]).nice().range([rH-rM,0]);

  const rSvg=d3.select("#roi-chart").append("svg")
      .attr("width",rW).attr("height",rH);

  rSvg.append("path")
      .datum(roi)
      .attr("fill","none")
      .attr("stroke","#1976d2")
      .attr("stroke-width",1.4)
      .attr("d",d3.line().x(d=>rx(d.t)).y(d=>ry(d.net)));

  rSvg.append("circle")
      .attr("cx",rx(peak.t)).attr("cy",ry(peak.net))
      .attr("r",3).attr("fill","#1976d2");

  rSvg.append("text")
      .attr("x",rW/2).attr("y",rH-6)
      .attr("text-anchor","middle")
      .attr("font-size",".68rem").attr("font-weight","700")
      .text(`Peak ₱${peak.net.toFixed(0)} at ≥${peak.t}`);

  rSvg.append("circle").attr("id","roi-cur").attr("r",3).attr("fill","#d32f2f");

  /* ---------- DOM REFERENCES ---------- */
  const slider=d3.select("#threshold"),
        thresh=d3.select("#thresh-val"),
        acc=d3.select("#acc-rate"),def=d3.select("#def-rate"),
        accB=d3.select("#acc-bank"),defB=d3.select("#def-bank"),
        accT=d3.select("#acc-telco"),defT=d3.select("#def-telco"),
        benL=d3.select("#benefit-loan"),benA=d3.select("#benefit-app"),benAB=d3.select("#benefit-app-bank"),
        thinN=d3.select("#thin-count"),target=d3.select("#target-def"),
        toggle=d3.select("#thin-toggle");

  /* ---------- HALO LAYER ---------- */
  const halos = svg.append("g"); let haloOn=false;

  function renderHalos(t){
      const fC=d=>d.comb>=t,
            fB=d=>d.bank<=11-t,          // bank-only accept
            thin=d=>d.bank>=8&&d.telco>=6&&fC(d)&&!fB(d);   // thin-file that bank would reject
      const sel=halos.selectAll("circle.halo").data(haloOn?data.filter(thin):[],d=>`${d.telco}-${d.bank}-${d.comb}`);
      sel.enter().append("circle")
          .attr("class","halo")
          .attr("cx",d=>x(d.telco))
          .attr("cy",d=>y(d.bank))
          .attr("r",14)
          .attr("fill","none")
          .attr("stroke","var(--thin-green)")
          .attr("stroke-width",2.5)
          .style("animation","pulse 1.4s ease-out infinite");
      sel.exit().remove();
  }

  /* ---------- MAIN UPDATE ---------- */
  function update(t){
      thresh.text(t);

      const fC=d=>d.comb>=t,
            fT=d=>d.telco>=t,
            fB=d=>d.bank<=11-t;

      const sC=stats(fC), sB=stats(fB), sT=stats(fT);

      /* metrics */
      acc.text((sC.acc*100).toFixed(1)+"%"); def.text((sC.pd*100).toFixed(1)+"%");
      accB.text((sB.acc*100).toFixed(1)+"%"); defB.text((sB.pd*100).toFixed(1)+"%");
      accT.text((sT.acc*100).toFixed(1)+"%"); defT.text((sT.pd*100).toFixed(1)+"%");

      const netLoan=REV-(sC.pd*LGD),
            netApp =netLoan*sC.acc,
            netBank=(REV-(sB.pd*LGD))*sB.acc;

      benL.text("₱"+netLoan.toFixed(0));
      benA.text("₱"+netApp.toFixed(0));
      benAB.text("₱"+netBank.toFixed(0));

      thinN.text(d3.sum(data.filter(d=>d.bank>=8&&d.telco>=6&&fC(d)&&!fB(d)),d=>d.n));

      /* greyscale fade */
      gDots.selectAll("circle.main").attr("opacity",d=>fC(d)?1:FADE);
      gDots.selectAll("circle.hl").attr("opacity",d=>fC(d)?0.18:0.18*FADE);
      gDots.selectAll("text").attr("opacity",d=>fC(d)?1:FADE);

      /* ROI marker */
      rSvg.select("#roi-cur")
          .attr("cx",rx(t))
          .attr("cy",ry(netApp));

      /* halos */
      renderHalos(t);
  }

  slider.on("input", function(){ update(+this.value); });
  update(1);  // initial state

  /* play/pause loop */
  let timer=null;
  d3.select("#toggle").on("click",function(){
      if(timer){ clearInterval(timer); timer=null; this.textContent="Play"; return; }
      this.textContent="Pause";
      timer=setInterval(()=>{
        let v=+slider.node().value;
        v=v<10 ? v+1 : 1;
        slider.node().value=v;
        update(v);
      },1500);
  });

  /* goal-seek default % */
  target.on("change blur",function(){
      const v=parseFloat(this.value);
      if(isNaN(v)){ this.value=""; return; }
      const tgt=v/100;
      let best=1, bestPd=stats(d=>d.comb>=1).pd;
      d3.range(1,11).forEach(t=>{
          const pd=stats(d=>d.comb>=t).pd;
          if(Math.abs(pd-tgt) < Math.abs(bestPd-tgt)){ best=t; bestPd=pd; }
      });
      slider.node().value=best;
      update(best);
  });

  /* halo toggle */
  toggle.on("click",function(){
      haloOn=!haloOn;
      toggle.classed("active",haloOn).text(haloOn?"Hide":"Highlight");
      update(+slider.node().value);
  });

}); // end CSV load
</script>
</body>
</html>

















