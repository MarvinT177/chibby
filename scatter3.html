
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Bank Internal Score &amp; FinScore Telco</title>
<script src="d3.v7.min.js"></script>
<style>
    :root{--card-bg:#fff;--shadow-lg:0 6px 14px rgba(0,0,0,.12);--shadow-sm:0 2px 6px rgba(0,0,0,.08);--inset:inset 0 1px 2px rgba(255,255,255,.6)}
    body{font-family:"Helvetica Neue",Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#333}
    h1{text-align:center;margin:0 0 15px;font-size:1.45rem}
    #chart-container{display:flex;flex-direction:column;align-items:center}
    #controls{margin:18px 0;display:flex;gap:18px;align-items:center;background:var(--card-bg);border-radius:10px;box-shadow:var(--shadow-sm),var(--inset);padding:10px 18px;border:1px solid #d5d5d5}
    input[type=range]{-webkit-appearance:none;width:240px;height:6px;background:#d0d0d0;border-radius:3px;outline:none}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#616161;border:2px solid #fff;cursor:pointer;box-shadow:var(--shadow-sm)}
    input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#616161;border:2px solid #fff;cursor:pointer;box-shadow:var(--shadow-sm)}
    button{background:#616161;color:#fff;border:none;border-radius:6px;padding:6px 16px;font-size:.9rem;cursor:pointer;box-shadow:var(--shadow-sm)}
    button:hover{background:#424242}
    #metrics{display:flex;gap:40px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .metric-box{background:var(--card-bg);border-radius:10px;padding:12px 22px;box-shadow:var(--shadow-lg),var(--inset);text-align:center;min-width:240px}
    .metric-box h3{margin:0 0 6px;font-size:.95rem;color:#666}
    .metric-box span{font-size:1.5rem;font-weight:bold}
    .sub-metrics{display:flex;gap:14px;margin-top:8px;justify-content:center;flex-wrap:wrap}
    .sub-box{background:#f5f7fa;border-radius:8px;padding:6px 10px;min-width:110px;box-shadow:var(--shadow-sm),var(--inset)}
    .sub-box h4{margin:0;font-size:.7rem;font-weight:600;color:#555;text-align:center}
    .sub-box span{font-size:.9rem;font-weight:bold}
    input[type=number]{width:64px;border:1px solid #aaa;border-radius:6px;padding:4px 6px;text-align:right;font-size:.85rem}
    svg#scatter{background:linear-gradient(160deg,#e9f4ff 0%,#ffffff 70%);border-radius:12px;box-shadow:var(--shadow-lg)}
    #roi-box{background:var(--card-bg);border-radius:10px;padding:12px 22px;box-shadow:var(--shadow-lg),var(--inset);text-align:center;margin-top:22px;width:420px}
    #roi-box h3{margin:0 0 8px;font-size:.95rem;color:#666}
    #roi-chart svg{overflow:visible}
    .thin-num{font-size:1.4rem;font-weight:bold;color:#2f5}
</style>
</head>
<body>
<h1>Bank Internal Score &amp; FinScore Telco</h1>

<div id="chart-container">
    <svg id="scatter" width="820" height="620"></svg>

    <div id="controls">
        <label for="threshold"><strong>Combined&nbsp;Score&nbsp;≥</strong>&nbsp;<span id="thresh-val">1</span></label>
        <input type="range" id="threshold" min="1" max="10" step="1" value="1">
        <button id="toggle">Play</button>
    </div>

    <div id="metrics">
        <div class="metric-box">
            <h3>Combined Approval Rate</h3><span id="acc-rate">0%</span>
            <div class="sub-metrics">
                <div class="sub-box"><h4>Bank Only</h4><span id="acc-bank">0%</span></div>
                <div class="sub-box"><h4>Telco Only</h4><span id="acc-telco">0%</span></div>
            </div>
        </div>

        <div class="metric-box">
            <h3>Combined Default Rate</h3><span id="def-rate">0%</span>
            <div class="sub-metrics">
                <div class="sub-box"><h4>Bank Only</h4><span id="def-bank">0%</span></div>
                <div class="sub-box"><h4>Telco Only</h4><span id="def-telco">0%</span></div>
            </div>
            <div style="margin-top:6px;font-size:.8rem;color:#555">Target % 
                <input id="target-def" type="number" min="0" max="100" step="0.1" placeholder=" ">
            </div>
        </div>

        <div class="metric-box">
            <h3>Peso Benefit</h3>
            <div class="sub-metrics" style="gap:10px">
                <div class="sub-box"><h4>Net /<br>Approved Loan</h4><span id="benefit-loan">₱0</span></div>
                <div class="sub-box"><h4>Avg /<br>Application</h4><span id="benefit-app">₱0</span></div>
                <div class="sub-box"><h4>Bank Only<br>Avg / App</h4><span id="benefit-app-bank">₱0</span></div>
            </div>
        </div>

        <div class="metric-box">
            <h3>Thin-File Approvals Gained</h3>
            <span id="thin-count" class="thin-num">0</span>
            <div style="margin-top:4px;font-size:.8rem;color:#555">Bank Score ≥ 8 &amp; Telco ≥ 6</div>
        </div>
    </div>

    <div id="roi-box">
        <h3>Sweet-Spot ROI Curve (Avg ₱ / Application)</h3>
        <div id="roi-chart"></div>
    </div>
</div>

<script>
const REV_PER_LOAN=2500, LGD_PER_LOAN=6500, CSV_PATH="data.csv", RADIUS=14, FADE=0.2;

/* Scales */
const svg=d3.select("#scatter"),W=+svg.attr("width"),H=+svg.attr("height"),
      M={top:50,right:50,bottom:80,left:100},
      x=d3.scaleLinear().domain([1,10]).range([M.left+RADIUS,W-M.right-RADIUS]),
      y=d3.scaleLinear().domain([1,10]).range([M.top+RADIUS,H-M.bottom-RADIUS]),
      colour=d3.scaleThreshold().domain([0.11,0.20,0.32,0.42,0.50])
             .range(["#9CCC65","#D4E157","#FFEE58","#FFCA28","#FFA726","#FF7043"]);

d3.csv(CSV_PATH,d3.autoType).then(raw=>{
  const data=d3.rollups(raw.filter(r=>!Object.values(r).some(v=>v==="#N/A"||v===null)),
      v=>({telco:v[0]["FinScore Telco"],bank:v[0]["Bank Internal Score"],comb:v[0]["Combined Score"],bad:d3.mean(v,d=>d["Good/Bad Flag"]),n:v.length}),
      d=>`${d["FinScore Telco"]}-${d["Bank Internal Score"]}-${d["Combined Score"]}`).map(d=>d[1]);

  const totalApps=d3.sum(data,d=>d.n);

  /* ---------- (Axes, dots, tooltip code same as last version) ---------- */
  /* (omitted here for brevity—unchanged from previous answer) */
  /* -------------------------------------------------------------------- */

  /* Stats helper */
  const stats=f=>{const s=data.filter(f),n=d3.sum(s,d=>d.n);return {acc:n/totalApps,pd:n?d3.sum(s,d=>d.n*d.bad)/n:0,n};};

  /* ROI curve setup (same as before, omitted) */

  /* DOM refs */
  const slider=d3.select("#threshold"),threshV=d3.select("#thresh-val"),
        accSp=d3.select("#acc-rate"),defSp=d3.select("#def-rate"),
        accBankSp=d3.select("#acc-bank"),accTelSp=d3.select("#acc-telco"),
        defBankSp=d3.select("#def-bank"),defTelSp=d3.select("#def-telco"),
        benLoanSp=d3.select("#benefit-loan"),benAppSp=d3.select("#benefit-app"),benAppBankSp=d3.select("#benefit-app-bank"),
        thinSp=d3.select("#thin-count"),targetBox=d3.select("#target-def");

  function update(t){
      threshV.text(t);

      const fComb=d=>d.comb>=t, fTel=d=>d.telco>=t, fBank=d=>d.bank<=11-t;

      const sComb=stats(fComb), sBank=stats(fBank), sTel=stats(fTel);

      const netLoan=REV_PER_LOAN-(sComb.pd*LGD_PER_LOAN),
            netApp=netLoan*sComb.acc,
            netAppBank=(REV_PER_LOAN-(sBank.pd*LGD_PER_LOAN))*sBank.acc;

      accSp.text((sComb.acc*100).toFixed(1)+"%");
      defSp.text((sComb.pd*100).toFixed(1)+"%");
      accBankSp.text((sBank.acc*100).toFixed(1)+"%"); defBankSp.text((sBank.pd*100).toFixed(1)+"%");
      accTelSp.text((sTel.acc*100).toFixed(1)+"%");  defTelSp.text((sTel.pd*100).toFixed(1)+"%");
      benLoanSp.text("₱"+netLoan.toFixed(0)); benAppSp.text("₱"+netApp.toFixed(0)); benAppBankSp.text("₱"+netAppBank.toFixed(0));

      thinSp.text(d3.sum(data.filter(d=>d.bank>=8&&d.telco>=6&&fComb(d)),d=>d.n));

      gDots.selectAll("circle.main").attr("opacity",d=>fComb(d)?1:FADE);
      gDots.selectAll("circle.hl").attr("opacity",d=>fComb(d)?0.18:0.18*FADE);
      gDots.selectAll("text").attr("opacity",d=>fComb(d)?1:FADE);

      rSvg.select("#roi-current").attr("cx",rx(t)).attr("cy",ry(netApp));
  }

  /* ---------- slider & play/pause events ---------- */
  slider.on("input",function(){update(+this.value);});
  update(1);

  let timer=null;
  d3.select("#toggle").on("click",function(){
      if(timer){clearInterval(timer);timer=null;this.textContent="Play";return;}
      this.textContent="Pause";
      timer=setInterval(()=>{let v=+slider.node().value;v=v<10?v+1:1;slider.node().value=v;update(v);},1500);
  });

  /* ---------- Target default-rate box ---------- */
  targetBox.on("change blur",function(){
      const val=+this.value;
      if(!val && val!==0) return;     // blank -> ignore
      const target=val/100;

      // find threshold giving pd <= target and closest
      let best=1, bestPd=stats(d=>d.comb>=1).pd;
      d3.range(1,11).forEach(t=>{
          const pd=stats(d=>d.comb>=t).pd;
          if(pd<=target && (target-pd)<=(target-bestPd)){best=t;bestPd=pd;}
      });
      slider.node().value=best;
      update(best);
  });
});
</script>
</body>
</html>






