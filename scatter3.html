
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Bank Internal Score &amp; FinScore Telco</title>
<script src="d3.v7.min.js"></script>
<style>
/* ------------ GLOBAL ------------ */
:root{--card-bg:#fff;--shadow-lg:0 4px 10px rgba(0,0,0,.12);--shadow-sm:0 2px 4px rgba(0,0,0,.08)}
body{font-family:"Helvetica Neue",Arial,sans-serif;background:#f5f5f5;margin:0;padding:14px;color:#333;font-size:13px}
h1{text-align:center;margin:0 0 10px;font-size:1.15rem}

/* ------------ FLEX LAYOUT ------------ */
#dashboard{display:flex;gap:14px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
#left-col,#right-col{display:flex;flex-direction:column;gap:12px}
#center-col{display:flex;flex-direction:column;align-items:center;gap:12px}
@media(max-width:900px){#dashboard{flex-direction:column;align-items:center}}

/* ------------ CARD BASE ------------ */
.metric-box{background:var(--card-bg);border-radius:8px;padding:6px 10px;box-shadow:var(--shadow-lg);
            text-align:center;min-width:140px;max-width:140px}
.metric-box h3{margin:0 0 3px;font-size:.72rem;color:#666}
.metric-box span{font-size:1.05rem;font-weight:600}
.sub-metrics{display:flex;gap:6px;margin-top:3px;justify-content:center;flex-wrap:wrap}
.sub-box{background:#f6f7f9;border-radius:6px;padding:4px 4px;min-width:64px;box-shadow:var(--shadow-sm)}
.sub-box h4{margin:0;font-size:.55rem;font-weight:600;color:#555;text-align:center}
.sub-box span{font-size:.7rem;font-weight:600}
.thin-num{font-size:1rem;font-weight:600;color:#2f5}
input[type=number]{width:56px;border:1px solid #aaa;border-radius:6px;padding:3px 5px;text-align:right;font-size:.7rem}

/* ------------ CONTROLS ------------ */
#controls{display:flex;gap:10px;align-items:center;background:var(--card-bg);border-radius:8px;
          box-shadow:var(--shadow-sm);padding:5px 12px;border:1px solid #d5d5d5}
input[type=range]{-webkit-appearance:none;width:150px;height:4px;background:#d0d0d0;border-radius:3px}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;
    background:#616161;border:2px solid #fff;cursor:pointer;box-shadow:var(--shadow-sm)}
input[type=range]::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:#616161;border:2px solid #fff;cursor:pointer;box-shadow:var(--shadow-sm)}
button{background:#616161;color:#fff;border:none;border-radius:6px;padding:3px 10px;font-size:.7rem;cursor:pointer;box-shadow:var(--shadow-sm)}
button:hover{background:#424242}

/* ------------ CHART ------------ */
svg#scatter{background:linear-gradient(160deg,#e9f4ff 0%,#ffffff 70%);border-radius:10px;box-shadow:var(--shadow-lg)}

/* ------------ SQUARE ROI ------------ */
#roi-box{background:var(--card-bg);border-radius:8px;padding:6px 10px;box-shadow:var(--shadow-lg);
         text-align:center;min-width:140px;max-width:140px}
#roi-box h3{margin:0 0 3px;font-size:.72rem;color:#666}
#roi-chart svg{overflow:visible}
</style>
</head>
<body>
<h1>Bank Internal Score &amp; FinScore Telco</h1>

<div id="dashboard">
  <!-- LEFT -->
  <div id="left-col">
      <div class="metric-box">
          <h3>Combined Approval Rate</h3><span id="acc-rate">0%</span>
          <div class="sub-metrics">
              <div class="sub-box"><h4>Bank</h4><span id="acc-bank">0%</span></div>
              <div class="sub-box"><h4>Telco</h4><span id="acc-telco">0%</span></div>
          </div>
      </div>
      <div class="metric-box">
          <h3>Combined Default Rate</h3><span id="def-rate">0%</span>
          <div class="sub-metrics">
              <div class="sub-box"><h4>Bank</h4><span id="def-bank">0%</span></div>
              <div class="sub-box"><h4>Telco</h4><span id="def-telco">0%</span></div>
          </div>
          <div style="margin-top:3px;font-size:.62rem;color:#555">
              Target % <input id="target-def" type="number" min="0" max="100" step="0.1">
          </div>
      </div>
  </div>

  <!-- CENTER -->
  <div id="center-col">
      <svg id="scatter" width="540" height="420"></svg>
      <div id="controls">
          <label for="threshold" style="font-size:.72rem"><strong>Combined&nbsp;Score&nbsp;≥</strong>&nbsp;<span id="thresh-val">1</span></label>
          <input type="range" id="threshold" min="1" max="10" step="1" value="1">
          <button id="toggle">Play</button>
      </div>
  </div>

  <!-- RIGHT -->
  <div id="right-col">
      <div class="metric-box">
          <h3>Peso Benefit</h3>
          <div class="sub-metrics" style="gap:5px">
              <div class="sub-box"><h4>Net / Loan</h4><span id="benefit-loan">₱0</span></div>
              <div class="sub-box"><h4>Avg / App</h4><span id="benefit-app">₱0</span></div>
              <div class="sub-box"><h4>Bank Avg</h4><span id="benefit-app-bank">₱0</span></div>
          </div>
      </div>
      <div class="metric-box">
          <h3>Thin-File Gains</h3>
          <span id="thin-count" class="thin-num">0</span>
          <div style="margin-top:3px;font-size:.62rem;color:#555">Bank ≥ 8 &amp; Telco ≥ 6</div>
      </div>
      <div id="roi-box">
          <h3>ROI Curve</h3>
          <div id="roi-chart"></div>
      </div>
  </div>
</div>

<script>
/* -------- CONFIG -------- */
const REV_PER_LOAN=2500, LGD_PER_LOAN=6500, CSV_PATH="data.csv",
      RADIUS=10, FADE=.25, BASE_BANK_ACC=.70;

/* -------- SCALES & SVG -------- */
const svg=d3.select("#scatter"), W=+svg.attr("width"), H=+svg.attr("height"),
      M={top:38,right:40,bottom:60,left:80};

const x=d3.scaleLinear().domain([1,10]).range([M.left+RADIUS,W-M.right-RADIUS]),
      y=d3.scaleLinear().domain([1,10]).range([M.top+RADIUS,H-M.bottom-RADIUS]),
      colour=d3.scaleThreshold().domain([.11,.20,.32,.42,.50])
             .range(["#9CCC65","#D4E157","#FFEE58","#FFCA28","#FFA726","#FF7043"]);

d3.csv(CSV_PATH,d3.autoType).then(raw=>{

  const data=d3.rollups(
      raw.filter(r=>!Object.values(r).some(v=>v==="#N/A"||v===null)),
      v=>({telco:v[0]["FinScore Telco"],bank:v[0]["Bank Internal Score"],
           comb:v[0]["Combined Score"],bad:d3.mean(v,d=>d["Good/Bad Flag"]),n:v.length}),
      d=>`${d["FinScore Telco"]}-${d["Bank Internal Score"]}-${d["Combined Score"]}`
  ).map(d=>d[1]);

  const booked=d3.sum(data,d=>d.n), totalApps=booked/BASE_BANK_ACC;

  /* AXES */
  svg.append("g").attr("transform",`translate(0,${H-M.bottom})`)
     .call(d3.axisBottom(x).ticks(10)).selectAll(".domain,.tick line")
     .attr("stroke","#7f7f7f").attr("stroke-width",1.4);
  svg.append("g").attr("transform",`translate(${M.left},0)`)
     .call(d3.axisLeft(y).ticks(10)).selectAll(".domain,.tick line")
     .attr("stroke","#7f7f7f").attr("stroke-width",1.4);
  svg.append("text").attr("x",W/2).attr("y",H-M.bottom+42)
     .attr("text-anchor","middle").attr("font-size",".8rem").attr("font-weight","bold")
     .text("FinScore Telco");
  svg.append("text").attr("transform","rotate(-90)").attr("x",-H/2).attr("y",M.left-60)
     .attr("text-anchor","middle").attr("font-size",".8rem").attr("font-weight","bold")
     .text("Bank Internal");

  /* DOTS */
  const defs=svg.append("defs");
  defs.append("filter").attr("id","drop").append("feDropShadow")
      .attr("dx",1).attr("dy",1).attr("stdDeviation",1).attr("flood-color","#000").attr("flood-opacity",.32);
  defs.append("filter").attr("id","inner")
      .html('<feGaussianBlur stdDeviation="1.5" result="b"/><feComposite operator="over" in2="b"/>');

  const gDots=svg.append("g").attr("filter","url(#drop)");
  gDots.selectAll("circle.main").data(data).join("circle")
      .attr("class","main").attr("cx",d=>x(d.telco)).attr("cy",d=>y(d.bank))
      .attr("r",RADIUS).attr("fill",d=>colour(d.bad))
      .attr("filter","url(#inner)").attr("stroke","#333").attr("stroke-width",.4);
  gDots.selectAll("circle.hl").data(data).join("circle")
      .attr("class","hl").attr("cx",d=>x(d.telco)-RADIUS/3).attr("cy",d=>y(d.bank)-RADIUS/3)
      .attr("r",RADIUS*.4).attr("fill","#fff").attr("opacity",.18).attr("pointer-events","none");
  gDots.selectAll("text").data(data).join("text")
      .attr("x",d=>x(d.telco)).attr("y",d=>y(d.bank)).attr("dy",".35em")
      .attr("text-anchor","middle").attr("font-size",".58rem").attr("font-weight","600")
      .attr("fill","#000").attr("pointer-events","none")
      .text(d=>d3.format(".0%")(d.bad));

  /* TOOLTIP */
  const tip=d3.select("body").append("div")
      .style("position","absolute").style("pointer-events","none")
      .style("background","#fff").style("border","1px solid #ccc")
      .style("padding","4px 7px").style("border-radius","6px")
      .style("box-shadow","var(--shadow-sm)").style("font-size",".65rem").style("opacity",0);

  gDots.selectAll("circle.main")
      .on("mouseover",(e,d)=>tip.style("opacity",1).html(
        `<strong>T:</strong> ${d.telco}&nbsp; <strong>B:</strong> ${d.bank}<br>
         Comb: ${d.comb} &nbsp; Pd: ${(d.bad*100).toFixed(1)}%<br>N: ${d.n}`))
      .on("mousemove",e=>tip.style("left",(e.pageX+9)+"px").style("top",(e.pageY-26)+"px"))
      .on("mouseout",()=>tip.style("opacity",0));

  /* STATS HELPER */
  const stats=f=>{const s=data.filter(f),n=d3.sum(s,d=>d.n);return{acc:n/totalApps,pd:n?d3.sum(s,d=>d.n*d.bad)/n:0,n}};

  /* ROI (square) */
  const roi=d3.range(1,11).map(t=>{const s=stats(d=>d.comb>=t);return{t,net:(REV_PER_LOAN-(s.pd*LGD_PER_LOAN))*s.acc}}),
        peak=roi.reduce((a,b)=>b.net>a.net?b:a), rW=140,rH=140,rM=24,
        rx=d3.scaleLinear().domain([1,10]).range([0,rW-rM]),
        ry=d3.scaleLinear().domain([0,d3.max(roi,d=>d.net)]).nice().range([rH-rM,0]);
  const rSvg=d3.select("#roi-chart").append("svg").attr("width",rW).attr("height",rH);
  rSvg.append("path").datum(roi).attr("fill","none").attr("stroke","#1976d2").attr("stroke-width",1.4)
      .attr("d",d3.line().x(d=>rx(d.t)).y(d=>ry(d.net)));
  rSvg.append("circle").attr("cx",rx(peak.t)).attr("cy",ry(peak.net)).attr("r",3).attr("fill","#1976d2");
  rSvg.append("text").attr("x",rx(peak.t)).attr("y",ry(peak.net)+15)
      .attr("text-anchor","middle").attr("font-size",".55rem")
      .text(`Peak ₱${peak.net.toFixed(0)} at ≥${peak.t}`);
  rSvg.append("circle").attr("id","roi-cur").attr("r",3).attr("fill","#d32f2f");

  /* DOM REFS */
  const slider=d3.select("#threshold"),threshV=d3.select("#thresh-val"),
        accSp=d3.select("#acc-rate"),defSp=d3.select("#def-rate"),
        accBankSp=d3.select("#acc-bank"),accTelSp=d3.select("#acc-telco"),
        defBankSp=d3.select("#def-bank"),defTelSp=d3.select("#def-telco"),
        benLoanSp=d3.select("#benefit-loan"),benAppSp=d3.select("#benefit-app"),benAppBankSp=d3.select("#benefit-app-bank"),
        thinSp=d3.select("#thin-count"),targetBox=d3.select("#target-def");

  function update(t){
      threshV.text(t);
      const fComb=d=>d.comb>=t, fTel=d=>d.telco>=t, fBank=d=>d.bank<=11-t;
      const sComb=stats(fComb), sBank=stats(fBank), sTel=stats(fTel);

      const netLoan=REV_PER_LOAN-(sComb.pd*LGD_PER_LOAN),
            netApp=netLoan*sComb.acc,
            netAppBank=(REV_PER_LOAN-(sBank.pd*LGD_PER_LOAN))*sBank.acc;

      accSp.text((sComb.acc*100).toFixed(1)+"%");   defSp.text((sComb.pd*100).toFixed(1)+"%");
      accBankSp.text((sBank.acc*100).toFixed(1)+"%"); defBankSp.text((sBank.pd*100).toFixed(1)+"%");
      accTelSp.text((sTel.acc*100).toFixed(1)+"%");  defTelSp.text((sTel.pd*100).toFixed(1)+"%");
      benLoanSp.text("₱"+netLoan.toFixed(0)); benAppSp.text("₱"+netApp.toFixed(0)); benAppBankSp.text("₱"+netAppBank.toFixed(0));
      thinSp.text(d3.sum(data.filter(d=>d.bank>=8&&d.telco>=6&&fComb(d)),d=>d.n));

      gDots.selectAll("circle.main").attr("opacity",d=>fComb(d)?1:FADE);
      gDots.selectAll("circle.hl").attr("opacity",d=>fComb(d)?0.18:0.18*FADE);
      gDots.selectAll("text").attr("opacity",d=>fComb(d)?1:FADE);

      rSvg.select("#roi-cur").attr("cx",rx(t)).attr("cy",ry(netApp));
  }

  slider.on("input",function(){update(+this.value);});
  update(1);

  /* autoplay */
  let timer=null;
  d3.select("#toggle").on("click",function(){
      if(timer){clearInterval(timer);timer=null;this.textContent="Play";return;}
      this.textContent="Pause";
      timer=setInterval(()=>{let v=+slider.node().value;v=v<10?v+1:1;slider.node().value=v;update(v);},1500);
  });

  /* goal-seek */
  targetBox.on("change blur",function(){const v=parseFloat(this.value);if(isNaN(v)){this.value="";return;}
      const tgt=v/100;let best=1,bestPd=stats(d=>d.comb>=1).pd;
      d3.range(1,11).forEach(t=>{const pd=stats(d=>d.comb>=t).pd;
          if(Math.abs(pd-tgt)<Math.abs(bestPd-tgt)){best=t;bestPd=pd;}});
      slider.node().value=best;update(best);});
});
</script>
</body>
</html>











