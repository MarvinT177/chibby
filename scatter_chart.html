
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>FinScore Scatter Plot</title>
<script src="d3.v7.min.js"></script>
<style>
body{font-family:Arial, sans-serif; background:#f3f4f6; margin:0; padding:20px; color:#333;}
h3{margin:0 0 8px 0;}
#chart-wrapper{display:flex; flex-direction:column; align-items:center;}
svg{background:#ffffff; border:1px solid #ccc; overflow:visible;}
#controls{margin-top:10px; display:flex; align-items:center; gap:10px;}
#legend{margin-top:10px;}
.legend-item{display:inline-flex; align-items:center; margin-right:15px; font-size:14px;}
.legend-swatch{width:14px; height:14px; margin-right:4px;}
#info-box{margin-top:15px; padding:10px 15px; background:#e2e8f0; border-radius:4px; text-align:center; min-width:240px;}
#benefit{font-size:24px; font-weight:bold;}
#metrics div{margin-top:4px;}
</style>
</head>
<body>
<div id="chart-wrapper">
    <svg id="scatterplot" width="800" height="480"></svg>

    <div id="controls">
        <button id="play-pause">Play</button>
        <input type="range" id="slider" min="1" max="10" step="0.1" value="5">
        <span id="slider-value">5.0</span>
    </div>

    <div id="legend"></div>

    <div id="info-box">
        <h3>Monetary benefit per application</h3>
        <div id="benefit">₱830</div>
        <div id="metrics">
            <div>Acceptance Rate: <span id="accept-rate">--</span>%</div>
            <div>Default Rate: <span id="default-rate">--</span>%</div>
        </div>
    </div>
</div>

<script>

// Configuration
const monetaryBase = 830;
const slider = d3.select("#slider");
const sliderValue = d3.select("#slider-value");
const playPauseBtn = d3.select("#play-pause");
let playing = false;
let timerId;

// Color scale for Good/Bad
const color = d3.scaleOrdinal()
    .domain([0,1])
    .range(["#1f77b4","#d62728"]); // Good=blue, Bad=red

// Load data
d3.csv("data.csv", d => {
    // Skip rows with any #N/A
    if (Object.values(d).some(v => v==="#N/A" || v===undefined || v===null || v==="")) return null;
    return {
        clientId: d["Client ID"],
        telco: +d["FinScore Telco"],
        bank: +d["Bank Internal Score"],
        combined: +d["Combined Score"],
        flag: +d["Good/Bad Flag"]
    };
}).then(raw => {
    // Filter null
    const data = raw.filter(d => d);

    // Scales
    const margin = {top:20,right:20,bottom:50,left:60};
    const width = 800 - margin.left - margin.right;
    const height = 480 - margin.top - margin.bottom;

    const x = d3.scaleLinear().domain([1,10]).range([0,width]);
    const y = d3.scaleLinear().domain([1,10]).range([height,0]); // Raw 1 best at top

    const r = d3.scaleLinear().domain(d3.extent(data, d=>d.combined)).range([4,12]);

    const svg = d3.select("#scatterplot")
        .attr("viewBox",[0,0,800,480])
        .append("g")
        .attr("transform",`translate(${margin.left},${margin.top})`);

    // Axes
    svg.append("g")
        .attr("transform",`translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(10));

    svg.append("g")
        .call(d3.axisLeft(y).ticks(10).tickFormat(d => 11 - d));

    svg.append("text")
        .attr("x",width/2)
        .attr("y",height+40)
        .attr("text-anchor","middle")
        .text("FinScore Telco (10 = Best)");

    svg.append("text")
        .attr("transform","rotate(-90)")
        .attr("x",-height/2)
        .attr("y",-45)
        .attr("text-anchor","middle")
        .text("Bank Internal Score (10 = Best)");

    // Points
    const dots = svg.append("g")
        .selectAll("circle")
        .data(data)
        .enter().append("circle")
        .attr("cx",d=>x(d.telco))
        .attr("cy",d=>y(d.bank))
        .attr("r",d=>r(d.combined))
        .attr("fill",d=>color(d.flag))
        .attr("fill-opacity",0.75)
        .attr("stroke","#444")
        .attr("stroke-width",0.5);

    // Legend
    const legend = d3.select("#legend");
    const legendItems = legend.selectAll(".legend-item")
        .data(color.domain())
        .enter().append("div")
        .attr("class","legend-item");

    legendItems.append("div")
        .attr("class","legend-swatch")
        .style("background",d=>color(d));

    legendItems.append("span")
        .text(d=> d===0 ? "Paid (Good)" : "Did not pay (Bad)");

    // ----- Slider interactivity -----
    function updateMetrics(threshold){
        const accepted = data.filter(d=>d.combined >= threshold);
        const acceptanceRate = (accepted.length / data.length) * 100;
        const defaults = accepted.filter(d=>d.flag === 1).length;
        const defaultRate = accepted.length ? (defaults / accepted.length) * 100 : 0;
        const benefit = (acceptanceRate/100) * monetaryBase;

        d3.select("#accept-rate").text(acceptanceRate.toFixed(1));
        d3.select("#default-rate").text(defaultRate.toFixed(1));
        d3.select("#benefit").text(`₱${benefit.toFixed(0)}`);
    }

    // Initial
    updateMetrics(+slider.node().value);

    // Slider input
    slider.on("input", function(){
        const t = +this.value;
        sliderValue.text(t.toFixed(1));
        updateMetrics(t);
    });

    // Play/Pause
    playPauseBtn.on("click", () => {
        playing = !playing;
        playPauseBtn.text(playing ? "Pause" : "Play");
        if(playing){
            timerId = d3.interval(() => {
                let v = +slider.node().value;
                v += 0.1;
                if(v > 10){
                    v = 1;
                }
                slider.node().value = v;
                slider.dispatch("input");
            }, 500);
        }else{
            if(timerId) timerId.stop();
        }
    });
});

</script>
</body>
</html>
